# ğŸš€ å¿«é€Ÿå‘å¸ƒå·¥ä½œæµ
#
# ä¸“é—¨ç”¨äºç›´æ¥æ¨é€åˆ° dev åˆ†æ”¯çš„å¿«é€Ÿå‘å¸ƒ
# å½“éœ€è¦å¿«é€Ÿå‘å¸ƒæµ‹è¯•ç‰ˆæœ¬æ—¶ä½¿ç”¨
#
# è§¦å‘æ¡ä»¶ï¼š
# - ç›´æ¥ push åˆ° dev åˆ†æ”¯
# - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# æ³¨æ„ï¼šè¿™ä¸ªå·¥ä½œæµä¼šè·³è¿‡PRå®¡æŸ¥ï¼Œç›´æ¥å‘å¸ƒæµ‹è¯•ç‰ˆæœ¬
# å»ºè®®ç”¨äºç´§æ€¥ä¿®å¤æˆ–å°èŒƒå›´æµ‹è¯•

name: ğŸš€ Quick Release

on:
  # ç›´æ¥ push åˆ° dev åˆ†æ”¯
  push:
    branches: [dev]
    paths:
      - 'zoo_framework/**'
      - 'pyproject.toml'
      - 'setup.py'
      - '.env'
      - '.github/workflows/quick-release.yml'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'å¿«é€Ÿå‘å¸ƒ - ç´§æ€¥ä¿®å¤æˆ–æµ‹è¯•'
        type: string

jobs:
  quick-release:
    name: ğŸš€ å¿«é€Ÿå‘å¸ƒ
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install build toml
      
      # è¿è¡Œå¿«é€Ÿæµ‹è¯•
      - name: Run quick tests
        run: |
          echo "ğŸ§ª è¿è¡Œå¿«é€Ÿæµ‹è¯•..."
          pytest tests/ -v --tb=short -k "not slow" || echo "âš ï¸ æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å‘å¸ƒæµç¨‹"
      
      # è·å–å½“å‰ç‰ˆæœ¬
      - name: Get current version
        id: current_version
        run: |
          # ä» .env æ–‡ä»¶è·å–ç‰ˆæœ¬
          if [ -f ".env" ]; then
            CURRENT_VERSION=$(grep "^VERSION=" .env | cut -d'=' -f2)
          else
            echo "âŒ æ— æ³•æ‰¾åˆ° .env æ–‡ä»¶"
            exit 1
          fi
          
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
      
      # è®¡ç®—æ–°ç‰ˆæœ¬ï¼ˆæ€»æ˜¯å¢åŠ patchå¹¶æ·»åŠ -betaï¼‰
      - name: Calculate new version
        id: calc_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          
          # è§£æç‰ˆæœ¬å·
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3 | cut -d- -f1)  # å»æ‰ -beta åç¼€
          
          # æ€»æ˜¯å¢åŠ patchå¹¶æ·»åŠ -beta
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH-beta"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          echo "å‘å¸ƒç±»å‹: å¿«é€Ÿæµ‹è¯•ç‰ˆæœ¬ (beta)"
      
      # æ›´æ–°ç‰ˆæœ¬å·
      - name: Update version
        run: |
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          
          # é…ç½® git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ›´æ–° .env æ–‡ä»¶
          sed -i "s/^VERSION=.*/VERSION=$NEW_VERSION/" .env
          
          # æ›´æ–°å…¶ä»–ç‰ˆæœ¬æ–‡ä»¶
          if [ -f "pyproject.toml" ]; then
            sed -i "s/version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml
          fi
          
          if [ -f "setup.py" ]; then
            sed -i "s/version='.*'/version='$NEW_VERSION'/" setup.py
          fi
          
          if [ -f "zoo_framework/__init__.py" ]; then
            sed -i "s/__version__ = \".*\"/__version__ = \"$NEW_VERSION\"/" zoo_framework/__init__.py
          fi
          
          # æäº¤æ›´æ”¹
          git add .
          git commit -m "chore(release): quick release $NEW_VERSION [skip ci]"
          git push
          
          echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æ¨é€åˆ° dev åˆ†æ”¯"
      
      # åˆ›å»º Git tag
      - name: Create Git Tag
        run: |
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          
          # åˆ›å»º tag
          git tag -a "v$NEW_VERSION" -m "Quick Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "âœ… Tag v$NEW_VERSION å·²åˆ›å»º"
      
      # æ„å»ºåŒ…
      - name: Build package
        run: python -m build
      
      # å‘å¸ƒåˆ° TestPyPI
      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN || secrets.PYPI_API_TOKEN }}
        continue-on-error: true
      
      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.calc_version.outputs.new_version }}
          name: Quick Release v${{ steps.calc_version.outputs.new_version }}
          body: |
            ## ğŸš€ å¿«é€Ÿå‘å¸ƒ v${{ steps.calc_version.outputs.new_version }}
            
            **ç±»å‹:** ğŸ§ª å¿«é€Ÿæµ‹è¯•ç‰ˆæœ¬
            **åˆ†æ”¯:** dev
            **è§¦å‘æ–¹å¼:** ç›´æ¥æ¨é€
            **è¯´æ˜:** ${{ github.event.inputs.release_notes || 'å¿«é€Ÿå‘å¸ƒ - ç´§æ€¥ä¿®å¤æˆ–æµ‹è¯•' }}
            
            ### âš ï¸ æ³¨æ„
            è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿå‘å¸ƒç‰ˆæœ¬ï¼Œè·³è¿‡äº†å®Œæ•´çš„PRå®¡æŸ¥æµç¨‹ã€‚
            å»ºè®®ç”¨äºï¼š
            - ç´§æ€¥bugä¿®å¤
            - å°èŒƒå›´åŠŸèƒ½æµ‹è¯•
            - å¼€å‘ç¯å¢ƒéªŒè¯
            
            ### ğŸ“¦ å®‰è£…
            ```bash
            # ä» TestPyPI å®‰è£…æµ‹è¯•ç‰ˆæœ¬
            pip install --index-url https://test.pypi.org/simple/ zoo-framework==${{ steps.calc_version.outputs.new_version }}
            ```
            
            ### ğŸ”„ åç»­æ­¥éª¤
            1. éªŒè¯ä¿®å¤æˆ–åŠŸèƒ½
            2. åˆ›å»ºæ­£å¼çš„PRè¿›è¡Œä»£ç å®¡æŸ¥
            3. é€šè¿‡æ ‡å‡†æµç¨‹å‘å¸ƒç¨³å®šç‰ˆæœ¬
          files: |
            dist/*.whl
            dist/*.tar.gz
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # å‘é€é€šçŸ¥
      - name: Notify Quick Release
        run: |
          echo "ğŸ‰ å¿«é€Ÿå‘å¸ƒå®Œæˆï¼"
          echo "ç‰ˆæœ¬: v${{ steps.calc_version.outputs.new_version }}"
          echo "ç±»å‹: å¿«é€Ÿæµ‹è¯•ç‰ˆæœ¬ (beta)"
          echo "TestPyPI: https://test.pypi.org/project/zoo-framework/${{ steps.calc_version.outputs.new_version }}/"
          echo "GitHub Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.calc_version.outputs.new_version }}"