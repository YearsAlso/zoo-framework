# ğŸš€ è‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ
#
# åŠŸèƒ½ï¼š
# 1. è‡ªåŠ¨ç‰ˆæœ¬å·è‡ªå¢ï¼ˆpatch/minor/majorï¼‰
# 2. è‡ªåŠ¨æ‰“ Git tag
# 3. è‡ªåŠ¨å‘å¸ƒåˆ° PyPI
# 4. è‡ªåŠ¨åˆ›å»º GitHub Release
#
# ğŸ“ æ‰‹åŠ¨è§¦å‘æ–¹å¼ï¼š
# GitHub â†’ Actions â†’ Release â†’ Run workflow â†’ é€‰æ‹©ç‰ˆæœ¬ç±»å‹
#
# ğŸ”‘ éœ€è¦é…ç½®çš„ Secretsï¼š
# - PYPI_API_TOKEN: PyPI API Tokenï¼ˆè§ä¸‹æ–¹é…ç½®è¯´æ˜ï¼‰
#
# ğŸ“Œ é…ç½® PYPI_API_TOKEN æ­¥éª¤ï¼š
# 1. è®¿é—® https://pypi.org/manage/account/token/
# 2. ç‚¹å‡» "Add API token"
# 3. Token name: "GitHub Actions"
# 4. Scope: "Entire account" æˆ–æŒ‡å®šé¡¹ç›®
# 5. å¤åˆ¶ç”Ÿæˆçš„ token
# 6. åˆ° GitHub â†’ Settings â†’ Secrets and variables â†’ Actions
# 7. ç‚¹å‡» "New repository secret"
# 8. Name: PYPI_API_TOKEN, Value: ç²˜è´´ token

name: ğŸš€ Release

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch  # ä¿®å¤ç‰ˆæœ¬ï¼š0.0.1 â†’ 0.0.2
          - minor  # æ¬¡è¦ç‰ˆæœ¬ï¼š0.0.x â†’ 0.1.0
          - major  # ä¸»è¦ç‰ˆæœ¬ï¼š0.x.x â†’ 1.0.0
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆå¯é€‰ï¼Œè°¨æ…ä½¿ç”¨ï¼‰
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'zoo_framework/**'
  #     - 'pyproject.toml'

jobs:
  # è¿è¡Œæµ‹è¯•
  test:
    name: ğŸ§ª è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        run: pytest --cov=zoo_framework --cov-fail-under=70

  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run Ruff
        run: ruff check zoo_framework
      
      - name: Run MyPy
        run: mypy zoo_framework
        continue-on-error: true

  # å‘å¸ƒæµç¨‹
  release:
    name: ğŸš€ å‘å¸ƒåˆ° PyPI
    needs: [test, quality]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feat-xmeng'
    
    permissions:
      contents: write  # ç”¨äºåˆ›å»º tag å’Œ release
      id-token: write  # ç”¨äº PyPI å¯ä¿¡å‘å¸ƒï¼ˆæ¨èï¼‰
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆ changelog
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build bump-my-version toml
      
      # è·å–å½“å‰ç‰ˆæœ¬
      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
      
      # ç‰ˆæœ¬å·è‡ªå¢
      - name: Bump version
        id: bump_version
        run: |
          # é…ç½® git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ä½¿ç”¨ bump-my-version è‡ªå¢ç‰ˆæœ¬å·
          pip install bump-my-version
          
          # æ ¹æ®è¾“å…¥é€‰æ‹©ç‰ˆæœ¬ç±»å‹
          VERSION_TYPE="${{ github.event.inputs.version_type || 'patch' }}"
          echo "ç‰ˆæœ¬ç±»å‹: $VERSION_TYPE"
          
          # è‡ªå¢ç‰ˆæœ¬å·
          bump-my-version bump $VERSION_TYPE
          
          # è·å–æ–°ç‰ˆæœ¬
          NEW_VERSION=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
      
      # æäº¤ç‰ˆæœ¬å·æ›´æ”¹
      - name: Commit version bump
        run: |
          git add pyproject.toml
          git commit -m "chore(release): bump version to ${{ steps.bump_version.outputs.new_version }} [skip ci]"
          git push
      
      # åˆ›å»º Git tag
      - name: Create Git Tag
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "âœ… Tag v$NEW_VERSION å·²åˆ›å»º"
      
      # æ„å»ºåŒ…
      - name: Build package
        run: python -m build
      
      # å‘å¸ƒåˆ° PyPIï¼ˆä½¿ç”¨ API Tokenï¼‰
      - name: Publish to PyPI
        if: success()
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          # å¦‚æœä½¿ç”¨ PyPI å¯ä¿¡å‘å¸ƒï¼ˆä¸éœ€è¦ tokenï¼‰ï¼Œæ³¨é‡Šæ‰ä¸Šé¢ä¸€è¡Œï¼Œä½¿ç”¨ä¸‹é¢ï¼š
          # attestations: true
      
      # ç”Ÿæˆ Changelog
      - name: Generate Changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            # ç¬¬ä¸€ä¸ª release
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
            CHANGELOG=$(git log "$LAST_TAG"..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$CHANGELOG" > CHANGELOG_TEMP.md
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump_version.outputs.new_version }}
          name: Release v${{ steps.bump_version.outputs.new_version }}
          body: |
            ## ğŸ‰ What's New in v${{ steps.bump_version.outputs.new_version }}
            
            ${{ github.event.inputs.release_notes || 'æŸ¥çœ‹æäº¤å†å²è·å–è¯¦ç»†ä¿¡æ¯' }}
            
            ### ğŸ“‹ Commits
            ${{ steps.changelog.outputs.changelog }}
            
            ### ğŸ“¦ å®‰è£…
            ```bash
            pip install zoo-framework==${{ steps.bump_version.outputs.new_version }}
            ```
            
            ### ğŸ“š æ–‡æ¡£
            - [å¼€å‘æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/docs/README.md)
            - [API å‚è€ƒ](https://github.com/${{ github.repository }}/blob/main/docs/API_REFERENCE.md)
          files: |
            dist/*.whl
            dist/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Notify Success
        if: success()
        run: |
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: v${{ steps.bump_version.outputs.new_version }}"
          echo "PyPI: https://pypi.org/project/zoo-framework/${{ steps.bump_version.outputs.new_version }}/"
          echo "Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.bump_version.outputs.new_version }}"
