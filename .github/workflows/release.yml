# ğŸš€ è‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ
#
# ç‰ˆæœ¬ç­–ç•¥ï¼š
# - dev åˆ†æ”¯: æµ‹è¯•ç‰ˆæœ¬ï¼Œpatch è‡ªå¢ (0.1.0 â†’ 0.1.1-beta)
# - main åˆ†æ”¯: æ­£å¼ç‰ˆæœ¬ï¼Œminor è‡ªå¢ (0.1.x â†’ 0.2.0)
#
# è§¦å‘æ¡ä»¶ï¼š
# - PR åˆå¹¶åˆ° dev åˆ†æ”¯
# - PR åˆå¹¶åˆ° main åˆ†æ”¯
#
# ğŸ”‘ éœ€è¦é…ç½®çš„ Secretsï¼š
# - PYPI_API_TOKEN: PyPI API Token
# - TEST_PYPI_API_TOKEN: TestPyPI API Tokenï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•å‘å¸ƒï¼‰

name: ğŸš€ Release

on:
  # PR åˆå¹¶åˆ° dev åˆ†æ”¯è§¦å‘æµ‹è¯•ç‰ˆæœ¬
  pull_request:
    types: [closed]
    branches: [dev]
  
  # PR åˆå¹¶åˆ° main åˆ†æ”¯è§¦å‘æ­£å¼ç‰ˆæœ¬
  # æ³¨æ„ï¼šmain åˆ†æ”¯ä¹Ÿä½¿ç”¨ PR åˆå¹¶è§¦å‘
  # å¦‚æœç›´æ¥ push åˆ° mainï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢çš„æ³¨é‡Šï¼š
  # push:
  #   branches: [main]

jobs:
  # ç¡®å®šç‰ˆæœ¬ç±»å‹å’Œæ˜¯å¦åº”è¯¥å‘å¸ƒ
  determine-release:
    name: ğŸ” ç¡®å®šå‘å¸ƒç±»å‹
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version_type: ${{ steps.check.outputs.version_type }}
      release_type: ${{ steps.check.outputs.release_type }}
      branch: ${{ steps.check.outputs.branch }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ç¡®å®šå‘å¸ƒç±»å‹
        id: check
        run: |
          # è·å–ç›®æ ‡åˆ†æ”¯
          TARGET_BRANCH="${{ github.base_ref }}"
          echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          echo "branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          
          if [ "$TARGET_BRANCH" == "dev" ]; then
            echo "ğŸ§ª æ£€æµ‹åˆ° dev åˆ†æ”¯åˆå¹¶"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=patch" >> $GITHUB_OUTPUT
            echo "release_type=beta" >> $GITHUB_OUTPUT
          elif [ "$TARGET_BRANCH" == "main" ]; then
            echo "ğŸš€ æ£€æµ‹åˆ° main åˆ†æ”¯åˆå¹¶"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=minor" >> $GITHUB_OUTPUT
            echo "release_type=stable" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ å…¶ä»–åˆ†æ”¯ï¼Œä¸è§¦å‘å‘å¸ƒ"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  # è¿è¡Œæµ‹è¯•
  test:
    name: ğŸ§ª è¿è¡Œæµ‹è¯•
    needs: determine-release
    if: needs.determine-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        run: pytest --cov=zoo_framework --cov-report=xml --cov-fail-under=60

  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    needs: determine-release
    if: needs.determine-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run Ruff
        run: ruff check zoo_framework
      
      - name: Run MyPy
        run: mypy zoo_framework
        continue-on-error: true

  # å‘å¸ƒæµç¨‹
  release:
    name: ğŸš€ å‘å¸ƒ
    needs: [determine-release, test, quality]
    if: needs.determine-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build toml
      
      # è·å–å½“å‰ç‰ˆæœ¬
      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
      
      # è®¡ç®—æ–°ç‰ˆæœ¬
      - name: Calculate new version
        id: calc_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          VERSION_TYPE="${{ needs.determine-release.outputs.version_type }}"
          RELEASE_TYPE="${{ needs.determine-release.outputs.release_type }}"
          
          # è§£æç‰ˆæœ¬å·
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3 | cut -d- -f1)  # å»æ‰ -beta åç¼€
          
          if [ "$VERSION_TYPE" == "minor" ]; then
            # minor è‡ªå¢: 0.1.0 â†’ 0.2.0
            MINOR=$((MINOR + 1))
            PATCH=0
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          else
            # patch è‡ªå¢: 0.1.0 â†’ 0.1.1-beta
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            if [ "$RELEASE_TYPE" == "beta" ]; then
              NEW_VERSION="${NEW_VERSION}-beta"
            fi
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
      
      # æ›´æ–°ç‰ˆæœ¬å·
      - name: Update version
        run: |
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          
          # é…ç½® git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ›´æ–° pyproject.toml
          sed -i "s/version = \"${{ steps.current_version.outputs.version }}\"/version = \"$NEW_VERSION\"/" pyproject.toml
          
          # æ›´æ–° __init__.py
          sed -i "s/__version__ = \"${{ steps.current_version.outputs.version }}\"/__version__ = \"$NEW_VERSION\"/" zoo_framework/__init__.py
          
          # æäº¤æ›´æ”¹
          git add pyproject.toml zoo_framework/__init__.py
          git commit -m "chore(release): bump version to $NEW_VERSION [skip ci]"
          git push
      
      # åˆ›å»º Git tag
      - name: Create Git Tag
        run: |
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          BRANCH="${{ needs.determine-release.outputs.branch }}"
          
          # åˆ›å»º tag
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "âœ… Tag v$NEW_VERSION å·²åˆ›å»º"
      
      # æ„å»ºåŒ…
      - name: Build package
        run: python -m build
      
      # å‘å¸ƒåˆ° PyPIï¼ˆæ­£å¼ç‰ˆæœ¬ï¼‰
      - name: Publish to PyPI (Stable)
        if: needs.determine-release.outputs.release_type == 'stable'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
      
      # å‘å¸ƒåˆ° TestPyPIï¼ˆæµ‹è¯•ç‰ˆæœ¬ï¼‰
      - name: Publish to TestPyPI (Beta)
        if: needs.determine-release.outputs.release_type == 'beta'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN || secrets.PYPI_API_TOKEN }}
        continue-on-error: true
      
      # ç”Ÿæˆ Changelog
      - name: Generate Changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          else
            CHANGELOG=$(git log "$LAST_TAG"..HEAD --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.calc_version.outputs.new_version }}
          name: Release v${{ steps.calc_version.outputs.new_version }}
          body: |
            ## ğŸ‰ Release v${{ steps.calc_version.outputs.new_version }}
            
            **ç±»å‹:** ${{ needs.determine-release.outputs.release_type == 'beta' && 'ğŸ§ª æµ‹è¯•ç‰ˆæœ¬' || 'ğŸš€ æ­£å¼ç‰ˆæœ¬' }}
            **åˆ†æ”¯:** ${{ needs.determine-release.outputs.branch }}
            **ç‰ˆæœ¬è‡ªå¢:** ${{ needs.determine-release.outputs.version_type }}
            
            ### ğŸ“‹ å˜æ›´è®°å½•
            ${{ steps.changelog.outputs.changelog }}
            
            ### ğŸ“¦ å®‰è£…
            
            ${{ needs.determine-release.outputs.release_type == 'beta' && '
            ```bash
            # æµ‹è¯•ç‰ˆæœ¬ï¼ˆä» TestPyPI å®‰è£…ï¼‰
            pip install --index-url https://test.pypi.org/simple/ zoo-framework==' || '
            ```bash
            # æ­£å¼ç‰ˆæœ¬
            pip install zoo-framework==' }}${{ steps.calc_version.outputs.new_version }}
            ```
            
            ### ğŸ“š æ–‡æ¡£
            - [å¼€å‘æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/docs/README.md)
            - [API å‚è€ƒ](https://github.com/${{ github.repository }}/blob/main/docs/API_REFERENCE.md)
          files: |
            dist/*.whl
            dist/*.tar.gz
          draft: false
          prerelease: ${{ needs.determine-release.outputs.release_type == 'beta' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # å‘é€é€šçŸ¥
      - name: Notify Success
        run: |
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: v${{ steps.calc_version.outputs.new_version }}"
          echo "ç±»å‹: ${{ needs.determine-release.outputs.release_type }}"
          echo "PyPI: https://pypi.org/project/zoo-framework/${{ steps.calc_version.outputs.new_version }}/"
