# ğŸš€ è‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ
#
# ç‰ˆæœ¬ç­–ç•¥ï¼š
# - dev åˆ†æ”¯: æµ‹è¯•ç‰ˆæœ¬ï¼Œpatch è‡ªå¢ (0.1.0 â†’ 0.1.1-beta)
# - main åˆ†æ”¯: æ­£å¼ç‰ˆæœ¬ï¼Œminor è‡ªå¢ (0.1.x â†’ 0.2.0)
#
# è§¦å‘æ¡ä»¶ï¼š
# - PR åˆå¹¶åˆ° dev åˆ†æ”¯ (æ¨èå·¥ä½œæµ)
# - ç›´æ¥ push åˆ° dev åˆ†æ”¯ (å¿«é€Ÿå‘å¸ƒ)
# - PR åˆå¹¶åˆ° main åˆ†æ”¯
#
# ğŸ”‘ éœ€è¦é…ç½®çš„ Secretsï¼š
# - PYPI_API_TOKEN: PyPI API Token
# - TEST_PYPI_API_TOKEN: TestPyPI API Tokenï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•å‘å¸ƒï¼‰

name: ğŸš€ Release

on:
  # è§¦å‘æ¡ä»¶ç®€åŒ–ï¼šç»Ÿä¸€ä½¿ç”¨ push äº‹ä»¶
  # å½“ PR åˆå¹¶åˆ° dev/main æ—¶ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€æ¬¡ push äº‹ä»¶ï¼Œæ‰€ä»¥è¿™å¯ä»¥è¦†ç›–æ‰€æœ‰åœºæ™¯
  # ä¸” push äº‹ä»¶çš„ OIDC èº«ä»½è®¤è¯ä¿¡æ¯æ›´ç¨³å®šï¼Œå®¹æ˜“åœ¨ PyPI é…ç½®
  push:
    branches: [dev, main]
    paths:
      - 'zoo_framework/**'
      - 'pyproject.toml'
      - 'setup.py'
      - '.env'
      - '.github/workflows/release.yml'

jobs:
  # ç¡®å®šç‰ˆæœ¬ç±»å‹å’Œæ˜¯å¦åº”è¯¥å‘å¸ƒ
  determine-release:
    name: ğŸ” ç¡®å®šå‘å¸ƒç±»å‹
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version_type: ${{ steps.check.outputs.version_type }}
      release_type: ${{ steps.check.outputs.release_type }}
      branch: ${{ steps.check.outputs.branch }}
      trigger_type: ${{ steps.check.outputs.trigger_type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ç¡®å®šå‘å¸ƒç±»å‹
        id: check
        run: |
          # ç°åœ¨çš„è§¦å‘ç±»å‹ç»Ÿä¸€ä¸º push
          TRIGGER_TYPE="push"
          TARGET_BRANCH="${{ github.ref_name }}"
          
          echo "è§¦å‘ç±»å‹: $TRIGGER_TYPE"
          echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          echo "trigger_type=$TRIGGER_TYPE" >> $GITHUB_OUTPUT
          echo "branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          
          if [ "$TARGET_BRANCH" == "dev" ]; then
            echo "ğŸ§ª æ£€æµ‹åˆ° dev åˆ†æ”¯æ›´æ–°"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=patch" >> $GITHUB_OUTPUT
            echo "release_type=beta" >> $GITHUB_OUTPUT
          elif [ "$TARGET_BRANCH" == "main" ]; then
            echo "ğŸš€ æ£€æµ‹åˆ° main åˆ†æ”¯æ›´æ–°"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=minor" >> $GITHUB_OUTPUT
            echo "release_type=stable" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ å…¶ä»–åˆ†æ”¯ï¼Œä¸è§¦å‘å‘å¸ƒ"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  # è¿è¡Œæµ‹è¯•
  test:
    name: ğŸ§ª è¿è¡Œæµ‹è¯•
    needs: determine-release
    if: needs.determine-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        run: pytest --cov=zoo_framework --cov-report=xml --cov-fail-under=30

  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    needs: determine-release
    if: needs.determine-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run Ruff
        run: ruff check zoo_framework
      
      - name: Run MyPy
        run: mypy zoo_framework
        continue-on-error: true

  # å‘å¸ƒæµç¨‹
  release:
    name: ğŸš€ å‘å¸ƒ
    needs: [determine-release, test, quality]
    if: needs.determine-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    
    # ä¿®æ”¹ä¸ºå§‹ç»ˆä½¿ç”¨ pypi ç¯å¢ƒï¼Œç»Ÿä¸€å‘å¸ƒåˆ°æ­£å¼ PyPI
    environment:
      name: pypi
      url: https://pypi.org/project/zoo-framework/

    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build toml
      
      # è·å–å½“å‰ç‰ˆæœ¬
      - name: Get current version
        id: current_version
        run: |
          # å°è¯•ä»å¤šä¸ªä½ç½®è·å–ç‰ˆæœ¬
          if [ -f "pyproject.toml" ]; then
            CURRENT_VERSION=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          elif [ -f ".env" ]; then
            CURRENT_VERSION=$(grep "^VERSION=" .env | cut -d'=' -f2)
          elif [ -f "setup.py" ]; then
            CURRENT_VERSION=$(grep "version=" setup.py | cut -d"'" -f2)
          else
            echo "âŒ æ— æ³•æ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯"
            exit 1
          fi
          
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
      
      # è®¡ç®—æ–°ç‰ˆæœ¬
      - name: Calculate new version
        id: calc_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          VERSION_TYPE="${{ needs.determine-release.outputs.version_type }}"
          RELEASE_TYPE="${{ needs.determine-release.outputs.release_type }}"
          TRIGGER_TYPE="${{ needs.determine-release.outputs.trigger_type }}"
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "ç‰ˆæœ¬ç±»å‹: $VERSION_TYPE"
          echo "å‘å¸ƒç±»å‹: $RELEASE_TYPE"
          echo "è§¦å‘ç±»å‹: $TRIGGER_TYPE"
          
          # è§£æç‰ˆæœ¬å·
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3 | cut -d- -f1)  # å»æ‰ -beta åç¼€
          
          if [ "$VERSION_TYPE" == "minor" ]; then
            # minor è‡ªå¢: 0.1.0 â†’ 0.2.0
            MINOR=$((MINOR + 1))
            PATCH=0
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          else
            # patch è‡ªå¢: 0.1.0 â†’ 0.1.1-beta
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            if [ "$RELEASE_TYPE" == "beta" ]; then
              NEW_VERSION="${NEW_VERSION}-beta"
            fi
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
      
      # æ›´æ–°ç‰ˆæœ¬å·
      - name: Update version
        id: update_version
        continue-on-error: true
        run: |
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          
          # é…ç½® git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ›´æ–° .env æ–‡ä»¶
          if [ -f ".env" ]; then
            sed -i "s/^VERSION=.*/VERSION=$NEW_VERSION/" .env
            git add .env
          fi
          
          # æ›´æ–° pyproject.toml
          if [ -f "pyproject.toml" ]; then
            sed -i "s/version = \"${{ steps.current_version.outputs.version }}\"/version = \"$NEW_VERSION\"/" pyproject.toml
            git add pyproject.toml
          fi
          
          # æ›´æ–° setup.py
          if [ -f "setup.py" ]; then
            sed -i "s/version='${{ steps.current_version.outputs.version }}'/version='$NEW_VERSION'/" setup.py
            git add setup.py
          fi
          
          # æ›´æ–° __init__.py
          if [ -f "zoo_framework/__init__.py" ]; then
            sed -i "s/__version__ = \"${{ steps.current_version.outputs.version }}\"/__version__ = \"$NEW_VERSION\"/" zoo_framework/__init__.py
            git add zoo_framework/__init__.py
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "chore(release): bump version to $NEW_VERSION [skip ci]"
          
          # å¦‚æœæ˜¯pushè§¦å‘ï¼Œç›´æ¥æ¨é€
          if [[ "${{ needs.determine-release.outputs.trigger_type }}" == "push" ]]; then
            echo "ğŸ“¤ ç›´æ¥æ¨é€ç‰ˆæœ¬æ›´æ–°åˆ° dev åˆ†æ”¯"
            # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥ï¼ˆå› ä¸ºåˆ†æ”¯ä¿æŠ¤ï¼‰åˆ™æ‰“å°è­¦å‘Šä½†ä¸è®©æ•´ä¸ªæµç¨‹å¤±è´¥
            if git push; then
              echo "âœ… ç‰ˆæœ¬å·å·²å›å†™åˆ°ä»“åº“"
            else
              echo "âš ï¸ æ— æ³•æ¨é€åˆ°å—ä¿æŠ¤çš„åˆ†æ”¯ã€‚è¯·æ‰‹åŠ¨æ›´æ–°ä»“åº“ä¸­çš„ç‰ˆæœ¬å·åˆ° $NEW_VERSIONã€‚"
              echo "è¿™ä¸ä¼šå½±å“æœ¬æ¬¡ PyPI å‘å¸ƒï¼Œä½†åœ¨ä¸‹ä¸€æ¬¡å‘å¸ƒå‰è¯·ç¡®ä¿ä»£ç åº“ç‰ˆæœ¬ä¸€è‡´ã€‚"
              # æˆ‘ä»¬ä¸é€€å‡ºï¼Œå…è®¸åç»­å‘å¸ƒæ­¥éª¤ç»§ç»­è¿›è¡Œ
            fi
          else
            echo "â³ PRåˆå¹¶è§¦å‘ï¼Œç­‰å¾…åç»­æ­¥éª¤"
          fi
      
      # åˆ›å»º Git tag
      - name: Create Git Tag
        continue-on-error: true
        run: |
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          BRANCH="${{ needs.determine-release.outputs.branch }}"
          
          # åˆ›å»º tag
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          # å°è¯•æ¨é€ Tagï¼ŒåŒæ ·å¦‚æœå¤±è´¥å…è®¸ç»§ç»­
          if git push origin "v$NEW_VERSION"; then
             echo "âœ… Tag v$NEW_VERSION å·²åˆ›å»º"
          else
             echo "âš ï¸ æ— æ³•æ¨é€ Tagã€‚å¯èƒ½æ˜¯æƒé™ä¸è¶³ã€‚"
          fi

      # æ„å»ºåŒ…
      - name: Build package
        run: python -m build
      
      # å‘ä¸åˆ° PyPI
      # æ— è®º release_type æ˜¯ stable è¿˜æ˜¯ betaï¼Œéƒ½å‘å¸ƒåˆ°æ­£å¼ PyPI
      # Beta ç‰ˆæœ¬ä¼šè‡ªåŠ¨è¢«æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆå› ä¸ºç‰ˆæœ¬å·å¸¦ -beta åç¼€ï¼‰
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
      
      # ç”Ÿæˆ Changelog
      - name: Generate Changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          else
            CHANGELOG=$(git log "$LAST_TAG"..HEAD --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.calc_version.outputs.new_version }}
          name: Release v${{ steps.calc_version.outputs.new_version }}
          body: |
            ## ğŸ‰ Release v${{ steps.calc_version.outputs.new_version }}
            
            **ç±»å‹:** ${{ needs.determine-release.outputs.release_type == 'beta' && 'ğŸ§ª æµ‹è¯•ç‰ˆæœ¬' || 'ğŸš€ æ­£å¼ç‰ˆæœ¬' }}
            **åˆ†æ”¯:** ${{ needs.determine-release.outputs.branch }}
            **è§¦å‘æ–¹å¼:** ${{ needs.determine-release.outputs.trigger_type == 'push' && 'ç›´æ¥æ¨é€' || 'PRåˆå¹¶' }}
            **ç‰ˆæœ¬è‡ªå¢:** ${{ needs.determine-release.outputs.version_type }}
            
            ### ğŸ“‹ å˜æ›´è®°å½•
            ${{ steps.changelog.outputs.changelog }}
            
            ### ğŸ“¦ å®‰è£…
            
            ```bash
            pip install zoo-framework==${{ steps.calc_version.outputs.new_version }}
            ```
            
            ### ğŸ“š æ–‡æ¡£
            - [å¼€å‘æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/docs/README.md)
            - [API å‚è€ƒ](https://github.com/${{ github.repository }}/blob/main/docs/API_REFERENCE.md)
          files: |
            dist/*.whl
            dist/*.tar.gz
          draft: false
          prerelease: ${{ needs.determine-release.outputs.release_type == 'beta' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # å‘é€é€šçŸ¥
      - name: Notify Success
        run: |
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: v${{ steps.calc_version.outputs.new_version }}"
          echo "ç±»å‹: ${{ needs.determine-release.outputs.release_type }}"
          echo "è§¦å‘: ${{ needs.determine-release.outputs.trigger_type }}"
          echo "PyPI: https://pypi.org/project/zoo-framework/${{ steps.calc_version.outputs.new_version }}/"

